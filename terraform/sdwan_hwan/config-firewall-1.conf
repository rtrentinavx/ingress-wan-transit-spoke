Content-Type: multipart/mixed; boundary="==AZURE=="
MIME-Version: 1.0

--==AZURE==
Content-Type: text/x-shellscript; charset="us-ascii"
MIME-Version: 1.0

config system global
    set hostname ${firewall_name}
end

config system probe-response
    set mode http-probe
end

config system interface
    edit port1
    set alias untrust
    set mode static
    set ip ${port1_ip} ${port1_mask}
    set allowaccess ping probe-response
    next
    edit port2
    set alias trust 
    set mode static
    set ip ${port2_ip} ${port2_mask}
    set allowaccess ping https ssh fgfm probe-response
    next
    edit port3
    set alias ha
    set mode static
    set ip ${port3_ip} ${port3_mask}
    next
    edit port4
    set alias mgmt
    set mode static
    set ip ${port4_ip} ${port4_mask}
    set allowaccess ping https ssh fgfm
    next
    edit Loopback
        set vdom "root"
        set ip ${loopback}
        set allowaccess ping https ssh snmp fgfm
        set type loopback
        set role lan
    next        
end

config sys ha
    set group-name Azure-HA
    set mode a-p
    set hbdev port3 100
    set session-pickup enable
    set ha-mgmt-status enable
    config  ha-mgmt-interfaces
        edit 1
        set interface port4
        set gateway ${ha_mgmt_gwy}
    next
    end
    set override disable
    set priority 255
    set unicast-hb enable
    set unicast-hb-peerip ${passive_peerip}
end

config router static
    edit 1
        set device port1
        set gateway ${defaultgwy}
    next
    edit 2
        set dst ${transit_gateway_prefix} ${transit_gateway_length}
        set gateway ${rfc1918gwy}
        set device "port2"
        set comment "Transit VNET"
    next
    edit 3
        set dst 168.63.129.16 255.255.255.255
        set gateway ${defaultgwy}
        set device "port1"
        set comment "Azure LB Health Probe"
    next
    edit 4
        set dst 168.63.129.16 255.255.255.255
        set gateway ${rfc1918gwy}
        set device "port2"
        set comment "Azure LB Health Probe"
    next
    edit 5
        set dst ${mgmt_prefix} ${port4_mask}
        set gateway ${rfc1918gwy}
        set device "port2"
        set comment "route to mgmt reservation subnet"
    next
    edit 6
        set dst ${ars_vnet_cidr}
        set gateway ${rfc1918gwy}
        set device "port2"
        set comment "route to ARS VNET"
    next
    end

config router prefix-list
    edit rfc1918-to-ars
    config rule
    edit 1
    set prefix 10.0.0.0 255.0.0.0
    next
    edit 2
    set action deny
    set prefix 0.0.0.0 0.0.0.0
    next
    end
    next
    edit local-azure-prefixes
    config rule 
    edit 1
    set prefix ${azure_region_summary}
    set le 32
    next
    end
    next
end

config router route-map
    edit rfc1918-to-ars
    config rule
    edit 1
    set match-ip-address rfc1918-to-ars
    next
    end
    next
    edit ars-to-sdwan
    config rule
    edit 1
    set match-ip-address local-azure-prefixes
    set set-local-preference 200
    next
    edit 2
    set action deny
    next
    end
    next
end

config router bgp
    set as ${forti_as_num}
    set router-id ${forti_router_id}
    set ebgp-multipath enable
    set graceful-restart enable
    config network
        edit 1
            set prefix ${mgmt_prefix} ${port4_mask}
        next
    end
    config neighbor
    edit ${ars-0}
    set description ARS_Peer_1 
    set ebgp-enforce-multihop enable
    set ebgp-multihop-ttl 16
    set interface port2
    set remote-as ${ars-asn}
    set route-map-in ars-to-sdwan
    set route-map-out rfc1918-to-ars
    set soft-reconfiguration enable
    next
    edit ${ars-1}
    set description ARS_Peer_2
    set ebgp-enforce-multihop enable
    set ebgp-multihop-ttl 16
    set interface port2
    set remote-as ${ars-asn}
    set route-map-in ars-to-sdwan
    set route-map-out rfc1918-to-ars
    set soft-reconfiguration enable
    next
    end
    config redistribute "connected"
    set status enable
    end
end

%{ if type == "byol" }
--==AZURE==
Content-Type: text/plain; charset="us-ascii"
MIME-Version: 1.0
Content-Transfer-Encoding: 7bit
Content-Disposition: attachment; filename="license"

${file(license_file)}

%{ endif }
--==AZURE==--
